name: Tic Tac Toe CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'weather_app/**'
      - 'docker-compose.yml'
      - '.github/workflows/pipeline.yml'
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v3
    
    - name: ğŸ—ï¸ Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: ğŸ³ Build Docker Image
      run: |
        echo "ğŸ”¨ Building Docker image..."
        docker build -t tic-tac-toe:${{ github.sha }} ./weather_app
        docker build -t tic-tac-toe:latest ./weather_app
        echo "âœ… Docker image built successfully"
        docker images | grep tic-tac-toe
    
    - name: ğŸ“Š Show Build Logs
      if: always()
      run: |
        echo "ğŸ” Build process completed"
        docker image ls tic-tac-toe

  deploy:
    name: Deploy with Docker Compose
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v3
    
    - name: ğŸ³ Build Docker Image
      run: |
        echo "ğŸ”¨ Building Docker image for deployment..."
        docker build -t tic-tac-toe:latest ./weather_app
    
    - name: ğŸš€ Deploy with Docker Compose
      run: |
        echo "ğŸ“¦ Starting deployment with Docker Compose..."
        docker compose up -d
        echo "âœ… Deployment completed"
    
    - name: ğŸ“‹ Show Deployment Logs
      if: always()
      run: |
        echo "ğŸ“Š Docker Compose Services Status:"
        docker compose ps
        echo ""
        echo "ğŸ“ Application Logs:"
        docker compose logs tic-tac-toe
    
    - name: â³ Wait for Service to be Ready
      run: |
        echo "â³ Waiting for application to start..."
        for i in {1..30}; do
          if docker compose exec -T tic-tac-toe curl -s http://localhost:5000/api/board > /dev/null; then
            echo "âœ… Application is ready!"
            exit 0
          fi
          echo "Attempt $i/30: Waiting for service..."
          sleep 2
        done
        echo "âŒ Application failed to start"
        exit 1
    
    - name: âœ… Verify Deployment
      run: |
        echo "ğŸ” Verifying deployment..."
        docker compose ps
        echo "âœ… Service is running"

  test:
    name: Run Application Tests
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v3
    
    - name: ğŸ³ Build Docker Image
      run: |
        docker build -t tic-tac-toe:latest ./weather_app
    
    - name: ğŸš€ Start Application
      run: |
        echo "ğŸš€ Starting application for testing..."
        docker compose up -d
        echo "âœ… Application started"
    
    - name: â³ Wait for Service
      run: |
        echo "â³ Waiting for service to be ready..."
        for i in {1..30}; do
          if docker compose exec -T tic-tac-toe curl -s http://localhost:5000/api/board > /dev/null; then
            echo "âœ… Service is ready!"
            exit 0
          fi
          echo "Attempt $i/30..."
          sleep 2
        done
        exit 1
    
    - name: ğŸŸ¢ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ Install Test Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: ğŸ§ª Run Automated Tests
      run: |
        echo "ğŸ§ª Starting automated test suite..."
        python test_app.py
        TEST_RESULT=$?
        echo "Test suite exit code: $TEST_RESULT"
        exit $TEST_RESULT
    
    - name: ğŸ“Š Show Application Logs (on failure)
      if: failure()
      run: |
        echo "ğŸ“ Application logs:"
        docker compose logs tic-tac-toe
    
    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        echo "ğŸ§¹ Cleaning up..."
        docker compose down
        echo "âœ… Cleanup completed"

  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [build, deploy, test]
    if: always()
    
    steps:
    - name: ğŸ“Š Pipeline Status
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ® TIC TAC TOE - CI/CD PIPELINE SUMMARY"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸ“¦ Build Stage: ${{ needs.build.result }}"
        echo "ğŸš€ Deploy Stage: ${{ needs.deploy.result }}"
        echo "ğŸ§ª Test Stage: ${{ needs.test.result }}"
        echo ""
        if [ "${{ needs.build.result }}" = "success" ] && [ "${{ needs.deploy.result }}" = "success" ] && [ "${{ needs.test.result }}" = "success" ]; then
          echo "âœ… PIPELINE SUCCESS - All stages passed!"
        else
          echo "âŒ PIPELINE FAILED - One or more stages failed"
          exit 1
        fi
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
